<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="../../../../scripts/buildfire.js"></script>
</head>

<body>
  <h2>Quote of the Day</h2>

  <div id="errorMsg" style="color: red; margin-bottom: 10px;"></div>

  <input id="quoteInput" type="text" placeholder="Enter a quote" style="width: 100%; padding: 8px;" />
  <input id="authorInput" type="text" placeholder="Enter the author"
    style="width: 100%; padding: 8px; margin-top: 8px;" />
  <input id="dateInput" type="date" style="width: 100%; padding: 8px; margin-top: 8px;" />
  <button id="saveBtn" style="margin-top: 10px; padding: 8px 16px;">Save Quote</button>

  <div id="quoteList" style="margin-top: 20px;"></div>

  <script>
    const quoteInput = document.getElementById("quoteInput");
    const authorInput = document.getElementById("authorInput");
    const dateInput = document.getElementById("dateInput");
    const saveBtn = document.getElementById("saveBtn");
    const quoteList = document.getElementById("quoteList");
    const errorMsg = document.getElementById("errorMsg");

    let allQuotes = [];

    function showError(message) {
      errorMsg.textContent = message;
      setTimeout(() => errorMsg.textContent = "", 4000);
    }

    function renderQuotes() {
      buildfire.datastore.search({}, "quotes", (err, result) => {
        if (err) return console.error("Error loading quotes:", err);
        allQuotes = result.map(item => ({ id: item.id, ...item.data }));

        quoteList.innerHTML = "";
        allQuotes.forEach(item => {
          const div = document.createElement("div");
          div.style.marginTop = "10px";
          div.innerHTML = `"${item.text}" â€” ${item.author || "Unknown"}<br/>
            <small>Scheduled: ${item.scheduledDate || "None"}</small>
            <button onclick="deleteQuote('${item.id}')">Delete</button>`;
          quoteList.appendChild(div);
        });
      });
    }

    function deleteQuote(id) {
      buildfire.datastore.delete(id, "quotes", (err) => {
        if (err) return console.error("Delete error:", err);
        renderQuotes();
      });
    }

    saveBtn.onclick = () => {
      const quoteText = quoteInput.value.trim();
      const authorText = authorInput.value.trim();
      const scheduledDate = dateInput.value || null;

      if (!quoteText) {
        showError("Quote cannot be empty");
        return;
      }

      // Check for duplicate scheduledDate
      if (scheduledDate && allQuotes.some(q => q.scheduledDate === scheduledDate)) {
        showError("A quote is already scheduled for this date.");
        return;
      }

      const newQuote = {
        text: quoteText,
        author: authorText,
        scheduledDate,
        createdAt: new Date().toISOString()
      };

      buildfire.datastore.insert(newQuote, "quotes", (err) => {
        if (err) return console.error("Save error:", err);
        quoteInput.value = "";
        authorInput.value = "";
        dateInput.value = "";
        renderQuotes();
      });
    };

    renderQuotes();
  </script>
</body>

</html>