<!DOCTYPE html>
<html>

<head>
  <!-- Makes the page scale properly on mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Loads BuildFire’s SDK so we can use its datastore API -->
  <script src="../../../../scripts/buildfire.js"></script>
</head>

<body>
  <h2>Quote of the Day</h2>

  <!-- Area to show any error messages to the user -->
  <div id="errorMsg" style="color: red; margin-bottom: 10px;"></div>

  <!-- Input field for entering the quote text -->
  <input id="quoteInput" type="text" placeholder="Enter a quote" style="width: 100%; padding: 8px;" />

  <!-- Input field for entering the quote’s author -->
  <input id="authorInput" type="text" placeholder="Enter the author"
    style="width: 100%; padding: 8px; margin-top: 8px;" />

  <!-- Date picker to schedule the quote for a specific day -->
  <input id="dateInput" type="date" style="width: 100%; padding: 8px; margin-top: 8px;" />

  <!-- Button to save the quote -->
  <button id="saveBtn" style="margin-top: 10px; padding: 8px 16px;">Save Quote</button>

  <!-- Container to display the list of saved quotes -->
  <div id="quoteList" style="margin-top: 20px;"></div>

  <script>
    // Grab references to the input fields and buttons
    const quoteInput = document.getElementById("quoteInput");
    const authorInput = document.getElementById("authorInput");
    const dateInput = document.getElementById("dateInput");
    const saveBtn = document.getElementById("saveBtn");
    const quoteList = document.getElementById("quoteList");
    const errorMsg = document.getElementById("errorMsg");

    // Store all the quotes currently saved in memory
    let allQuotes = [];

    // Show an error message temporarily
    function showError(message) {
      errorMsg.textContent = message;
      setTimeout(() => errorMsg.textContent = "", 4000); // Hide after 4 seconds
    }

    // Fetch and display all saved quotes from the BuildFire datastore
    function renderQuotes() {
      buildfire.datastore.search({}, "quotes", (err, result) => {
        if (err) return console.error("Error loading quotes:", err);

        // Save all quotes into our local array, adding the record ID
        allQuotes = result.map(item => ({ id: item.id, ...item.data }));

        // Clear out any existing quotes in the UI
        quoteList.innerHTML = "";

        // Go through each quote and create a div to display it
        allQuotes.forEach(item => {
          const div = document.createElement("div");
          div.style.marginTop = "10px";
          div.innerHTML = `"${item.text}" — ${item.author || "Unknown"}<br/>
            <small>Scheduled: ${item.scheduledDate || "None"}</small>
            <button onclick="deleteQuote('${item.id}')">Delete</button>`;
          quoteList.appendChild(div); // Add it to the quote list
        });
      });
    }

    // Delete a quote by its ID and refresh the list
    function deleteQuote(id) {
      buildfire.datastore.delete(id, "quotes", (err) => {
        if (err) return console.error("Delete error:", err);
        renderQuotes(); // Re-fetch and display updated quotes
      });
    }

    // Handle the "Save Quote" button click
    saveBtn.onclick = () => {
      // Get values from the input fields
      const quoteText = quoteInput.value.trim();
      const authorText = authorInput.value.trim();
      const scheduledDate = dateInput.value || null;

      // Make sure the quote isn’t empty
      if (!quoteText) {
        showError("Quote cannot be empty");
        return;
      }

      // Prevent two quotes from being scheduled for the same date
      if (scheduledDate && allQuotes.some(q => q.scheduledDate === scheduledDate)) {
        showError("A quote is already scheduled for this date.");
        return;
      }

      // Build the new quote object
      const newQuote = {
        text: quoteText,
        author: authorText,
        scheduledDate,
        createdAt: new Date().toISOString() // Store when it was created
      };

      // Save the quote to the BuildFire datastore
      buildfire.datastore.insert(newQuote, "quotes", (err) => {
        if (err) return console.error("Save error:", err);

        // Clear the input fields
        quoteInput.value = "";
        authorInput.value = "";
        dateInput.value = "";

        // Re-render the list of quotes with the new one included
        renderQuotes();
      });
    };

    // Load quotes right away when the page loads
    renderQuotes();
  </script>
</body>

</html>